<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Mi Carrito | Libros como Alas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
    <header class="sticky-top">
        <nav class="navbar navbar-expand-lg px-4 py-3">
            <div class="container">
                <a class="navbar-brand" th:href="@{/}">
                    <img th:src="@{/images/LogoLibroComoAlas.png}" alt="Libros como Alas Logo" class="logo-img">
                    <span>Libros como Alas</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto align-items-center">
                        <li class="nav-item"><a class="nav-link" th:href="@{/catalogo}">Catálogo</a></li>
                        <li class="nav-item"><a class="nav-link" href="#ubicanos">Ubícanos</a></li>
                        <li class="nav-item"><a class="nav-link" th:href="@{/carrito}">Mi Carrito</a></li>
                        <li class="nav-item ms-lg-3" sec:authorize="isAnonymous()">
                            <a class="btn btn-outline-dark" th:href="@{/login}">Iniciar Sesión</a>
                        </li>
                        <li class="nav-item dropdown ms-lg-3" sec:authorize="isAuthenticated()">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <span sec:authentication="name"></span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                <li><a class="dropdown-item" th:href="@{/perfil}">Mi Perfil</a></li>
                                <li sec:authorize="hasRole('ADMIN')"><a class="dropdown-item" th:href="@{/admin/dashboard}">Panel de Admin</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form th:action="@{/logout}" method="post" class="d-inline">
                                        <button type="submit" class="dropdown-item">Cerrar Sesión</button>
                                    </form>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container my-5 py-4">
        <div class="text-center mb-5">
            <h1 class="display-5">Mi Carrito de Compras</h1>
        </div>

        <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

        <div th:if="${carrito == null or carrito.items.isEmpty()}" class="text-center py-5 empty-cart-container">
            <i class="bi bi-cart-x" style="font-size: 5rem; color: #ccc;"></i>
            <p class="text-muted fs-4 mt-3">Tu carrito está vacío.</p>
            <p>Parece que aún no has añadido ningún libro. ¡Anímate a explorar!</p>
            <a th:href="@{/catalogo}" class="btn btn-dark mt-3">Explorar Catálogo</a>
        </div>

        <div th:if="${carrito != null and not carrito.items.isEmpty()}">
            <div class="row g-5">
                <div class="col-lg-8">
                    <div class="cart-items-table">
                        <div class="table-header d-none d-md-flex row">
                            <div class="col-md-6">Producto</div>
                            <div class="col-md-3 text-center">Cantidad</div>
                            <div class="col-md-3 text-end">Subtotal</div>
                        </div>

                        <div th:each="item : ${carrito.items}" class="cart-item-row row align-items-center">
                            <div class="col-12 col-md-6 d-flex align-items-center mb-3 mb-md-0">
                                <img th:src="${item.libro.portadaUrl ?: '/images/default-cover.jpg'}" class="cart-item-img">
                                <div class="ms-3">
                                    <h5 class="book-title mb-0" th:text="${item.libro.titulo}">Título del Libro</h5>
                                    <p class="book-author text-muted small" th:text="${item.libro.autor}">Autor</p>
                                </div>
                            </div>
                            <div class="col-6 col-md-3">
                                <p class="mb-0 text-center"><span class="fw-bold" th:text="${item.cantidad}">1</span></p>
                            </div>
                             <div class="col-4 col-md-3 text-md-end">
                                <span class="fw-bold" th:text="'S/ ' + ${#numbers.formatDecimal(item.subtotal, 1, 2)}">S/ 0.00</span>
                            </div>
                            <div class="col-2 col-md-12 mt-2 mt-md-0 text-end">
                                <form th:action="@{/carrito/eliminar}" method="post">
                                    <input type="hidden" name="itemId" th:value="${item.id}" />
                                    <button type="submit" class="btn btn-sm text-danger" title="Eliminar item"><i class="bi bi-trash"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <a th:href="@{/catalogo}" class="text-decoration-none text-dark fw-medium"><i class="bi bi-arrow-left"></i> Seguir comprando</a>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="cart-summary p-4 sticky-top">
                        <h4 class="mb-4">Resumen del Pedido</h4>
                        <div th:with="subtotal=${#aggregates.sum(carrito.items.![subtotal])}">
                            <div class="d-flex justify-content-between mb-2"><span class="text-muted">Subtotal</span><span class="fw-semibold" th:text="'S/ ' + ${#numbers.formatDecimal(subtotal, 1, 2)}"></span></div>
                            <div class="d-flex justify-content-between"><span class="text-muted">Envío (estimado)</span><span class="fw-semibold">S/ 10.00</span></div>
                            <hr>
                            <div class="d-flex justify-content-between h5"><span>Total</span><span class="fw-bold text-dark" th:text="'S/ ' + ${#numbers.formatDecimal(subtotal + 10, 1, 2)}"></span></div>
                        </div>
                        <div class="d-grid mt-4">
                            <a th:href="@{/pedido/checkout}" class="btn btn-dark btn-lg">Proceder al Pago</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="border-top py-4 mt-5">
        <div class="container text-center text-muted">
            <p class="mb-0">&copy; 2025 Libros como Alas. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>